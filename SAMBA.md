# SAMBA
## Instalación de samba en el servidor
- **apt install samba**
- **nano /etc/samba/smb.conf** editamos este fichero y añadimos al final de todo (no hay que añadir todo):
  - En el apartado de WORKGROUP hay que poner el nombre del dominio sin el .local
  - [Carpeta_compartida]
    - comment = "algún comentario que querramos hacer sobre la carpeta"
    - path = "dirección donde está la carpeta compartida"
    - guest ok = "permitir el acceso de invitados o usuarios no autenticados"
    - read only = "solo lectura, o si tienen permisos de escritura"
    - browseable = yes "para ver si es oculta o no, yes no es oculta"
    - create mask = "para establecer los permisos de creación de archivos y carpetas"
    - directoy mask = "para especificar los permisos de creación de directorios"
  - **Ejemplo**
    - [comun]
      - comment = carpeta comun
      - path = /mnt/comun
      - writeable = yes
      - guest ok = yes
    - [personales]
      - comment = carpeta personales
      - path = /mnt/personales
      - writeable = yes
      - browseable = no
      - guest ok = no
- salimos del archivo y comprobamos con **testparm** que todo va bien.
- reiniciamos samba con
  - **/etc/init.d/smbd restart**
  - **/etc/init.d/nmbd restart**
- **apt install smbclient** instalamos este paquete
- **smbclient -L servidor.ejemplo.local** ejecutamos este comando para ver que carpetas están compartidas. Cuando pide la contraseña del root no hace falta introducir la contraseña.
- Hay que añadir usuarios a samba (los mismos que hay en el LDAP):
  - **smbpasswd -a usuario**
  - **smbpasswd -e usuario**
  - una vez añadido a la base de datos de samba para ver los usuarios es con **pdbedit -L**, para borrar algún usuario es **smbpasswd -x usuario** y para desabilitar usuarios es  **smbpasswd-d usuario**.
- **chgrp grupo /mnt/carpeta_compartida/carpeta_compartida** cambiamos los propietarios de las carpetas.
- **chmod 700 /mnt/carpeta_compartida** cambiamos los permisos a las carpetas.
- hacemos lo mismo con las subcarpetas
## Desde un cliente:
- **apt install samba-common smbclient cifs-utils**
- **smbclient -L servidor.ejemplo.local** para ver los recursos compartidos
- En samba tenemos que montar a mano las carpetas:
  - vamos al archivo **/etc/fstab**
  - *//ip/carpeta_compartida /carpeta_en_local cifs defaults,username=usuario,password=contraseña 0 0*
  - *//ip/carpeta_compartida /carpeta_en_local cifs defaults,credentials=archivo_con_credenciales.txt 0 0* en el archivo_con_credenciales.txt hay que introducir el usuario y la contraseña en líneas diferentes, username=usuario y passwd=contraseña. cambiamos los permisos a 600 en el fichero.
  - **mount -a** para comprobar que no hay ningún error
  - **mount** para comprobar que está montado
- Abrimos el nautilus, nos desplazamos a otras ubicaciones, en la parte inferior sale la opción para conectarnos al servidor. introducimos: **smb://ip/** para acceder al servidor. De esta forma nos aparece una ventana para autenticarnos, tenemos que introducir las credenciales que pusimos en el fichero archivo_con_credenciales.txt
## Montar las carpetas sin tener que hacer los pasos del nautilus
- **apt install libpam-mount**
- **nano /etc/security/pam_mount.conf.xml** editamos este fichero y añadimos después de "volume definitions": 
- ```<volume server="ip" gid="10000" fstype="cifs" path="carpeta_compartida (solo se indica el nombre del recurso compartido, no toda la ruta)" mountpoint="carpeta_en_cliente"/>```
- **Ejemplo 1:**
- ```<volume server=”servidor.empresa.local” fstype=”cifs” pgrp=”GLDAP” path=”comun(nombre recurso compartido)” mountpoint=”/home/empresa.local/%(USER)/datos(no hay que crear la carpeta de datos se crea automáticamente)”/>```
- **Ejemplo 2:**
- ```<volume server=”servidor.empresa.local” fstype=”cifs” pgrp=”GLDAP” path=”personales/%(USER)” mountpoint=”/home/empresa.local/%(USER)/personal”/> ```
- (hay que hacerlo con las carpetas que querramos compartir)
![pam_mount](/img/pam_mount.png)
## Comprobación que todo está bien
- *Comprobación desde Linux*
  - Entramos en el cliente con un usuario del LDAP y vamos al nautilus para comprobar que montó las carpetas.
- *Comprobación desde Windows*
  - Introducimos la ip en el buscador **\\ip**
  - Nos pide credenciales, hay que introducir los usuarios que tenemos en la base de datos de samba.